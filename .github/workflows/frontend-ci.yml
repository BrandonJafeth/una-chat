# Workflow SSDLC completo: Snyk + Lint + Unit Tests + Build
# para proyectos Node / React / TypeScript / Vite

name: SSDLC CI/CD

on:
  push:
    branches: ["main", "develop"]
  pull_request:
    branches: ["main", "develop"]

permissions:
  contents: read

jobs:
  # --- 1Ô∏è‚É£ LINT ---
  lint:
    name: Lint (ESLint)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - name: Install dependencies
        run: npm ci
      - name: Run ESLint
        run: npm run lint

  # --- 2Ô∏è‚É£ UNIT TESTS (BDD) ---
  test:
    name: Unit Tests (Vitest / Jest)
    runs-on: ubuntu-latest
    needs: [lint]   # üëà solo corre si Lint pasa
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - name: Run Unit Tests
        run: npm run test:ci

  # --- 3Ô∏è‚É£ SNYK SECURITY ---
  snyk:
    name: Snyk Security (SAST + SCA + optional IaC/Container)
    runs-on: ubuntu-latest
    needs: [test]   # üëà corre solo si Lint y Tests pasaron
    permissions:
      contents: read
      security-events: write
      actions: read
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Set up Snyk CLI
        uses: snyk/actions/setup@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      # --- Snyk Code (SAST) ---
      - name: Snyk Code test (SAST)
        run: snyk code test --severity-threshold=high --sarif-file-output=snyk-code.sarif
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: Upload result to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: snyk-code.sarif

      # --- Snyk Open Source (SCA) ---
      - name: Snyk Open Source test (SCA)
        run: snyk test --severity-threshold=high --fail-on=all --all-projects
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: Snyk Open Source monitor
        run: snyk monitor --all-projects
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      # --- Snyk IaC ---
      - name: Detect IaC files
        id: detect_iac
        run: |
          shopt -s globstar nullglob
          files=( **/*.tf **/*.tfvars **/*.yaml **/*.yml )
          if [ ${#files[@]} -gt 0 ]; then
            echo "found=true" >> "$GITHUB_OUTPUT"
          else
            echo "found=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Snyk IaC test and report
        if: steps.detect_iac.outputs.found == 'true'
        run: snyk iac test --severity-threshold=high --report
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      # --- Snyk Container ---
      - name: Check Dockerfile
        id: dockerfile
        run: |
          if [ -f Dockerfile ]; then
            echo "present=true" >> "$GITHUB_OUTPUT"
          else
            echo "present=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Build a Docker image
        if: steps.dockerfile.outputs.present == 'true'
        run: docker build -t your/image-to-test .

      - name: Snyk Container monitor
        if: steps.dockerfile.outputs.present == 'true'
        run: snyk container monitor your/image-to-test --file=Dockerfile
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

  # --- 4Ô∏è‚É£ BUILD (opcional) ---
  build:
    name: Build (Vite)
    runs-on: ubuntu-latest
    needs: [snyk]   # üëà solo si pasa todo lo anterior
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: npm run build
